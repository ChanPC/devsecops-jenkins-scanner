def runBuild() {
    script {
        def result = null
        try {
            result = awsCodeBuild(credentialsType: 'keys', 
                projectName: "${params.WEBGOAT_PROJECTNAME}", 
                region: "${params.AWS_REGION}", 
                sourceControlType: 'project',
                artifactTypeOverride: 'S3',
                artifactPackagingOverride: 'ZIP',
                artifactLocationOverride: "${params.ARTIFACT_S3}",
                artifactPathOverride: "${params.WEBGOAT_PROJECTNAME}/${BUILD_ID}",
                artifactNameOverride: 'results.zip',
                downloadArtifacts: 'true')
            sh "echo ${result.getArtifactsLocation()}"
            sh "echo ${result.getBuildId()}"
            return result.getBuildId().split(':')
        } catch (Exception e) {
            result=e.getCodeBuildResult()
            currentBuild.result = "UNSTABLE"
        }
    }
}

def runJoernBuild() {
    script {
        def result = null
        try {
            result = awsCodeBuild(credentialsType: 'keys', 
                projectName: "${params.JOERN_PROJECTNAME}", 
                region: "${params.AWS_REGION}", 
                sourceControlType: 'jenkins', 
                artifactTypeOverride: 'S3',
                artifactPackagingOverride: 'ZIP',
                artifactLocationOverride: "${params.ARTIFACT_S3}",
                artifactPathOverride: "${params.JOERN_PROJECTNAME}/${BUILD_ID}",
                sourceLocationOverride: "${params.JOERN_PROJECTNAME}/${BUILD_ID}/results.zip", 
                sourceTypeOverride: 'S3',
                artifactNameOverride: 'output.zip',
                downloadArtifacts: 'true')
            sh "echo ${result.getArtifactsLocation()}"
            sh "echo ${result.getBuildId()}"
            return result.getBuildId().split(':')
        } catch (Exception e) {
            result=e.getCodeBuildResult()
            currentBuild.result = "UNSTABLE"
        }
    }    
}

pipeline {
    agent any
    parameters {
        string(name: 'WEBGOAT_PROJECTNAME', defaultValue: 'BuildImage74257FD8-G2bjbCQI8qQK', description: 'CodeBuild project name')
        string(name: 'JOERN_PROJECTNAME', defaultValue: 'JoernScan2FFB8D2D-jOHftB2JRzvL', description: 'CodeBuild project name')
        string(name: 'ARTIFACT_S3', defaultValue: 'codebuildstack-jenkinsbuildartifactsf33606a2-3nxorqcdc3qq', description: 'CodeBuild artifact bucket')
        choice(name: 'AWS_REGION', choices: ['ap-southeast-1'], description: 'AWS region')
    }
    stages {
        stage('Stage before') {
            steps {
                echo 'Do something before'
            }
        }
        stage('Web Goat Build on AWS CodeBuild') {
            steps {
                script{
                    def output = runBuild()
                    env.artifact_path = output[1]+"/"+output[0]
                    sh "ls -lR"
                    sh "unzip -o ./${params.WEBGOAT_PROJECTNAME}/${BUILD_ID}/results.zip -d ."
                }
            }
        }
        stage('Joern scan on AWS CodeBuild') {
            steps {
                script{
                    echo "Build number is ${currentBuild.number}"
                    def output = runJoernBuild()
                }
            }
        }
    }
    post { 
        always { 
            deleteDir()
        }
    }
}